<!doctype html><html><head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
  <title>WellAtlas by Henry Suden</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
</head><body>
  <div class="header-top"><h1 id="appTitle">WellAtlas by Henry Suden</h1></div>
  <div class="header-sub">
    <a class="btn blue" href="{{ url_for('customers_index') }}">Customers</a>
    <a class="btn green" href="{{ url_for('sites_index') }}">Sites</a>
    <a class="btn amber" href="{{ url_for('jobs_index') }}">Job #</a>
    <input id="searchInput" type="text" placeholder="Search customers, sites, jobs, notes">
    <select id="jobFilter"><option value="">All Jobs</option><option>Domestic</option><option>Drilling</option><option>Ag</option><option>Electrical</option></select>
    <select id="customerFilter"><option value="">All Customers</option></select>
    <button class="btn blue" id="goBtn" type="button">Search</button>
    <button class="btn gray" id="locateBtn" type="button">üìç Center on Me</button>
    <button class="btn amber" id="quickAddBtn" type="button">Ôºã Quick Add</button>
  </div>
  <main><div id="map"></div></main>

  <div class="modal" id="quickModal">
    <div class="sheet">
      <h2>Quick Add</h2>
      <p class="small">Create a customer, a site (prefilled with your location if available), and a job.</p>
      <form id="quickForm" class="grid2">
        <div>
          <label>Customer</label>
          <input name="customer_name" placeholder="Customer name" required>
          <input name="customer_phone" placeholder="Phone">
          <input name="customer_email" placeholder="Email">
        </div>
        <div>
          <label>Site</label>
          <input name="site_name" placeholder="Site name" required>
          <div class="inline-form">
            <input name="latitude" placeholder="Latitude" id="qaLat">
            <input name="longitude" placeholder="Longitude" id="qaLon">
            <button class="btn gray" id="fillGPS" type="button">Use My Location</button>
          </div>
        </div>
        <div>
          <label>Job</label>
          <input name="job_number" placeholder="Job # (25xxx)" required>
          <select name="job_category"><option>Domestic</option><option>Drilling</option><option>Ag</option><option>Electrical</option></select>
        </div>
        <div style="display:flex;gap:10px;align-items:flex-end">
          <button class="btn amber" type="submit">Save All</button>
          <button class="btn gray" id="closeModal" type="button">Close</button>
        </div>
      </form>
      <div id="quickMsg" class="small"></div>
    </div>
  </div>

<script>
const mtKey = "{{ maptiler_key }}";
const streets = L.tileLayer(`https://api.maptiler.com/maps/streets/{z}/{x}/{y}.png?key=${mtKey}`);
const hybrid = L.tileLayer(`https://api.maptiler.com/maps/hybrid/{z}/{x}/{y}.jpg?key=${mtKey}`);
const satellite = L.tileLayer(`https://api.maptiler.com/tiles/satellite-v2/{z}/{x}/{y}.jpg?key=${mtKey}`);
const map = L.map('map', { center:[39.9,-122.0], zoom:9, layers:[hybrid] });
L.control.layers({ "Hybrid": hybrid, "Streets": streets, "Satellite": satellite }).addTo(map);

let markersLayer = L.layerGroup().addTo(map); let currentMarkers = [];
function addMarker(site){
  if(!site.latitude || !site.longitude) return;
  const m = L.marker([site.latitude, site.longitude]);
  m.bindPopup(`<strong>${site.customer} ‚Äî ${site.name}</strong><br><a href="/site/${site.id}">View site</a>`);
  markersLayer.addLayer(m); currentMarkers.push(m);
}

async function loadCustomers(){
  const r = await fetch('/api/customers'); const data = await r.json();
  const sel = document.getElementById('customerFilter');
  sel.innerHTML = '<option value="">All Customers</option>' + data.map(c=>`<option>${c.name}</option>`).join('');
}

async function refresh(){
  markersLayer.clearLayers(); currentMarkers = [];
  const q = document.getElementById('searchInput').value || "";
  const job = document.getElementById('jobFilter').value || "";
  const cust = document.getElementById('customerFilter').value || "";
  const resp = await fetch(`/api/sites?q=${encodeURIComponent(q)}&job=${encodeURIComponent(job)}&customer=${encodeURIComponent(cust)}`);
  const data = await resp.json(); data.forEach(addMarker);
  if(currentMarkers.length){ const group = L.featureGroup(currentMarkers); map.fitBounds(group.getBounds().pad(0.2)); } else { map.setView([39.9,-122.0], 9); }
}
document.getElementById('goBtn').addEventListener('click', refresh);
document.getElementById('jobFilter').addEventListener('change', refresh);
document.getElementById('customerFilter').addEventListener('change', refresh);
document.getElementById('searchInput').addEventListener('keyup', (e)=>{ if(e.key==='Enter') refresh(); });

document.getElementById('locateBtn').addEventListener('click', () => {
  if(!navigator.geolocation){ alert('Geolocation not supported.'); return; }
  navigator.geolocation.getCurrentPosition((pos)=>{
    const {latitude, longitude} = pos.coords;
    map.setView([latitude, longitude], 14);
  }, (err)=>{ alert('Location error'); });
});
const modal = document.getElementById('quickModal');
document.getElementById('quickAddBtn').addEventListener('click', ()=> modal.classList.add('show'));
document.getElementById('closeModal').addEventListener('click', ()=> modal.classList.remove('show'));
document.getElementById('fillGPS').addEventListener('click', () => {
  if(!navigator.geolocation){ alert('Geolocation not supported.'); return; }
  navigator.geolocation.getCurrentPosition((pos)=>{
    document.getElementById('qaLat').value = pos.coords.latitude.toFixed(6);
    document.getElementById('qaLon').value = pos.coords.longitude.toFixed(6);
  }, (err)=>{ alert('Location error'); });
});
document.getElementById('quickForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const fd = new FormData(e.target);
  const payload = Object.fromEntries(fd.entries());
  const r = await fetch('/api/quick_add', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
  const j = await r.json();
  const msg = document.getElementById('quickMsg');
  if(j.ok){ msg.textContent = 'Saved!'; modal.classList.remove('show'); e.target.reset(); loadCustomers(); refresh(); }
  else { msg.textContent = 'Error: ' + (j.error || 'unknown'); }
});
loadCustomers().then(refresh);
</script>
</body></html>
